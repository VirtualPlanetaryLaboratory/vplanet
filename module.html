<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adding a New Module &mdash; VPLanet 2.5.1
 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=d948c9a6" />
      <link rel="stylesheet" type="text/css" href="_static/plot_directive.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=983e91d6"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Contributor’s Guide" href="developers.html" />
    <link rel="prev" title="Coupling Modules" href="coupling.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            VPLanet
          </a>
              <div class="version">
                2.5.1

              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installing VPLanet</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="help.html">Options and Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="src.html">C API</a></li>
<li class="toctree-l1"><a class="reference internal" href="vplot.html">VPLOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="parametersweep.html">Parameter Sweep Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Code Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="output.html">Add an Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="option.html">Add an Option</a></li>
<li class="toctree-l2"><a class="reference internal" href="primaryvariable.html">Add a Primary Variable</a></li>
<li class="toctree-l2"><a class="reference internal" href="coupling.html">Coupling Modules</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Add a New Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#initial-steps">Initial Steps</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-the-source-files">Creating the Source Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#memory-allocation">Memory Allocation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#option-functions">Option Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-and-halt-functions">Update and Halt Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#output-functions">Output Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#addmodule">AddModule</a></li>
<li class="toctree-l4"><a class="reference internal" href="#module-functions">Module Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-header-file">The Header File</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#updating-module-c">Updating module.c</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="http://faculty.washington.edu/rkb9/vplanet/Workshop21/">Workshop Lectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="developers.html">Contributor’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="repos.html">Other VPLanet Repositories</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/VirtualPlanetaryLaboratory/vplanet">GitHub</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">VPLanet</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Adding a New Module</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/module.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="adding-a-new-module">
<h1>Adding a New Module<a class="headerlink" href="#adding-a-new-module" title="Link to this heading"></a></h1>
<p>So you’ve decided you want to add a new module to VPLanet? That’s great as it is
the best way to improve the code and grow our understanding of planetary and
stellar evolution! This page walks you through the steps necessary to complete
that task. While numerous modules have been implemented to date and can serve
as examples, each new module presents unique challenges, but by following the
established protocols, your new module can be “plug and play” and couple
seamlessly to the other modules.</p>
<section id="initial-steps">
<h2>Initial Steps<a class="headerlink" href="#initial-steps" title="Link to this heading"></a></h2>
<p>Add a new ID number in vplanet.h:</p>
<blockquote>
<div><p>#define NEWMODULE 2^x</p>
</div></blockquote>
<p>where NEWMODULE is the name of your module and x is an integer that creates a
unique number for the module. Adjust the values to MODULEOPTEND and MODULEOUTEND.
Add a new struct member to the MODULE struct called <a href="#id1"><span class="problematic" id="id2">*</span></a>iaModuleName.</p>
<p>At the end of vplanet.h, add #include for your new .h file.</p>
<p>Identify the primary variables, if they are new to the code, follow the <a class="reference external" href="primaryvariable">How
to add a `primary variable</a> tutorial.</p>
<p>Determine which new options you need and follow the <a class="reference external" href="option">How to add an option</a> tutorial. Add all necessary members to the BODY struct, including new
options, primary variables, and auxiliary properties. Add all new outputs by
following the <a class="reference external" href="output">How to add an output</a> tutorial.</p>
</section>
<section id="creating-the-source-files">
<h2>Creating the Source Files<a class="headerlink" href="#creating-the-source-files" title="Link to this heading"></a></h2>
<p>For this tutorial, we will follow the format in eqtide.c, which is one of the
more mature and complicated modules in VPLanet.</p>
<section id="memory-allocation">
<h3>Memory Allocation<a class="headerlink" href="#memory-allocation" title="Link to this heading"></a></h3>
<p>The first function is InitializeControlEqtide which allocated memory for any
array in the CONTROL struct. In this case, we need arrays for each body related
to both rotational and orbital evolution. These arrays set how the evolution
will proceed with regards to tidally locking, or by fixing the orbit for tests.
If your module requires any functionality like this example, don’t forget to
modify the CONTROL struct in vplanet.h.</p>
<p>Next up is BodyCopy, which copies the member of the BODY struct to
control-&gt;tmpBody for use in the Runge-Kutta substeps. This function exists
because allocating memory at every timestep is an expensive calculation. Instead
we choose to pre-allocate a BODY struct inside CONTROL, which can increase the
speed of the code by over a factor of 10 in some cases. The trade off for this
approach is that all parameters must be copied in the BodyCopy functions.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Failure to add a BODY struct member to BodyCopy is a very common mistake! If
your changes are not working, make sure to check this function.</p>
</div>
<p>The next function is InitializeBodyEqtide, which allocates memory in the body
struct based on options. In this case, the BODY struct needs space for the total
number of bodies that can be tidal perturbers.</p>
<p>Next is the InitializeUpdateTmpBodyEqtide function that allocates memory in the
tmpBody struct inside CONTROL.</p>
</section>
<section id="option-functions">
<h3>Option Functions<a class="headerlink" href="#option-functions" title="Link to this heading"></a></h3>
<p>The next blocks of code are the functions for reading options, which were
discussed as part of the initial steps. Note that after InitializeOptions comes
the function ReadOptionsEqtide, which loops over all the options. Make sure your
starting and ending values in the for loop are correct.</p>
<p>After the ReadOptions functions come the Verify functions. As discussed in the
<a class="reference external" href="architecture">Code Architecture</a> page, these functions can take on many forms
that depend on the goal of the module. Recall that by the end of Verify, all the
options should be vetted for self-consistency, with errors handled in a friendly
way. After Verify, the code expects everything to be clean and ready for a fast
and accurate numerical integration.</p>
</section>
<section id="update-and-halt-functions">
<h3>Update and Halt Functions<a class="headerlink" href="#update-and-halt-functions" title="Link to this heading"></a></h3>
<p>The next sections of the code are for functions related to the UPDATE and HALT
functions. Most of the UPDATE functions should have been filled in when the
primary variables were added.</p>
<p>Next come the Halt functions, which are unique to the new module. All halts must
have the same argument list and must return a 1 (halt the code) or a 0 (do <em>not</em>
halt the code). After the individual halt functions, add the CountHalts and
VerifyHalts functions and your halting criteria will be evaluating at each
time step.</p>
</section>
<section id="output-functions">
<h3>Output Functions<a class="headerlink" href="#output-functions" title="Link to this heading"></a></h3>
<p>The output function format is similar to the options. However, note that there
are two categories of output files, the evolution (.forward) files and the log
file. EqTide breaks the logging into two functions because some outputs depend
on the number of perturbers. Please use these functions as a template if your
module contains similar functionality.</p>
</section>
<section id="addmodule">
<h3>AddModule<a class="headerlink" href="#addmodule" title="Link to this heading"></a></h3>
<p>The AddModule function contains the assignment of the function pointer matrices
that enable the module to be integrated into the main code. Essentially, all the
work you finished above to track options, outputs, variables, etc. comes
together in this function.</p>
</section>
<section id="module-functions">
<h3>Module Functions<a class="headerlink" href="#module-functions" title="Link to this heading"></a></h3>
<p>The final block of functions contain all the subroutines necessary to actually
compute the physics and chemistry for your module. These functions must be
tailored to your specific needs, but do remember that all primary variable
function must contain the same argument list (BODY*,SYSTEM*,int).</p>
</section>
<section id="the-header-file">
<h3>The Header File<a class="headerlink" href="#the-header-file" title="Link to this heading"></a></h3>
<p>At the same time you are developing the .c file, you’ll want to update the .h
file. These are all pretty standard across the modules, so use them as a
template. In these files you define numbers for the options and outputs, as well
as define prototype functions for all subroutines that can be called from other
files. You can also define any other macros unique to your module here.</p>
</section>
</section>
<section id="updating-module-c">
<h2>Updating module.c<a class="headerlink" href="#updating-module-c" title="Link to this heading"></a></h2>
<p>To finish your new module, you must also update several subroutines in module.c.
First, allocate and initialize the members of the MODULE struct in
InitializeModule. Then update FinalizeModule to increment the iNumModules
variable. Next, add a block of text for your module to AddModules that is
similar to the blocks already present. Then add the appropriate block of text to
ReadModules so that the code can actually find your new module! Next add
lines to PrintModuleList and InitializeBodyModules. The final step is to write
any <a class="reference external" href="coupling">multi-module PropsAux and ForceBehavior functions,</a> if
necessary. Congratulations! You’ve now written a new, bug-free module!</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="coupling.html" class="btn btn-neutral float-left" title="Coupling Modules" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="developers.html" class="btn btn-neutral float-right" title="Contributor’s Guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2024, The VPLanet Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>