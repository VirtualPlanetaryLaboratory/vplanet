<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How to Add a Primary Variable &mdash; VPLanet 2.5.1
 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=d948c9a6" />
      <link rel="stylesheet" type="text/css" href="_static/plot_directive.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=983e91d6"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Coupling Modules" href="coupling.html" />
    <link rel="prev" title="Add a VPLanet Option" href="option.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            VPLanet
          </a>
              <div class="version">
                2.5.1

              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installing VPLanet</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="help.html">Options and Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="src.html">C API</a></li>
<li class="toctree-l1"><a class="reference internal" href="vplot.html">VPLOT</a></li>
<li class="toctree-l1"><a class="reference internal" href="parametersweep.html">Parameter Sweep Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Code Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="output.html">Add an Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="option.html">Add an Option</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Add a Primary Variable</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#is-the-parameter-a-primary-variable">Is the parameter a primary variable?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#is-the-primary-variable-multi-module">Is the primary variable multi-module?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#declaration">Declaration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initialization">Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-new-primary-variable">Using the New Primary Variable</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="coupling.html">Coupling Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="module.html">Add a New Module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="http://faculty.washington.edu/rkb9/vplanet/Workshop21/">Workshop Lectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="developers.html">Contributor’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="repos.html">Other VPLanet Repositories</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/VirtualPlanetaryLaboratory/vplanet">GitHub</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">VPLanet</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">How to Add a Primary Variable</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/primaryvariable.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="how-to-add-a-primary-variable">
<h1>How to Add a Primary Variable<a class="headerlink" href="#how-to-add-a-primary-variable" title="Link to this heading"></a></h1>
<p>This page shows how to introduce a new primary variable into a VPLanet
module. For this tutorial, we add a variable called dPrimaryVariable to a
fictitious module called Physics that is in files called physics.[ch]. For your
new primary variable, replace “PrimaryVariable with the name of your new primary
variable and “”Physics” with the name of the module you are upgrading.</p>
<section id="is-the-parameter-a-primary-variable">
<h2>Is the parameter a primary variable?<a class="headerlink" href="#is-the-parameter-a-primary-variable" title="Link to this heading"></a></h2>
<p>A “primary variable” is a parameter whose evolution is explicitly tracked by
VPLanet, e.g. its evolution is controlled by an ordinary differential equation.
In other words, adding a primary variable is equivalent to adding a new
governing equation that fundamentally affects an object’s evolution.
If that is <strong>not</strong> the case, i.e. it depends only on other primary variables, then
you probably only need to add it to a struct (like BODY), some functions to
calculate its values, <a class="reference external" href="option">options</a> and/or <a class="reference external" href="outputs">outputs</a>, and a call
in PropsAux and/or ForceBehavior. In many cases just adding an output function
that explicitly calculates the value is sufficient.</p>
<p>If, however, this parameter is indeed a primary variable, this tutorial will
guide you through the steps to add it.</p>
</section>
<section id="is-the-primary-variable-multi-module">
<h2>Is the primary variable multi-module?<a class="headerlink" href="#is-the-primary-variable-multi-module" title="Link to this heading"></a></h2>
<p>Some variables can be modified by my multiple modules, while others will be
exclusive to a single module. For example, eccentricity can be affected by
both tidal evolution (EqTide) and/or planet-planet perturbations (SpiNbody or
DistOrb). The setup for the variable is the same, but multi-nodule primary
variables will require additional steps to fully integrate them. For this
tutorial, we focus on a single-modules primary variable. If your primary
variable is multi-module, complete the steps shown below, then look at how a
primary variable like dHecc (a variable related to eccentricity and longitude of
pericenter) are handled, including in module.c.</p>
</section>
<section id="declaration">
<h2>Declaration<a class="headerlink" href="#declaration" title="Link to this heading"></a></h2>
<p>The first step in creating a primary variable is to add it to the BODY struct in
vplanet.h, i.e.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>struct<span class="w"> </span>BODY<span class="w"> </span><span class="o">{</span>
<span class="w">  </span>...
<span class="w">  </span>double<span class="w"> </span>dPrimaryVariable<span class="p">;</span><span class="w">  </span>/**&lt;<span class="w"> </span>Dummy<span class="w"> </span>variable<span class="w"> </span><span class="k">for</span><span class="w"> </span>primary<span class="w"> </span>variable<span class="w"> </span>tutorial<span class="w"> </span>*/
<span class="w">  </span>...
<span class="o">}</span><span class="p">;</span>
</pre></div>
</div>
<p>If the new primary variable is part of an existing module, add it to the
corresponding block of code. Note the Doxygen comment.</p>
<p>Next, we add new members to the UPDATE struct, which contains the relevant info
to integrate the primary variable.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>struct<span class="w"> </span>UPDATE<span class="w"> </span><span class="o">{</span>
<span class="w">  </span>...
<span class="w">  </span>int<span class="w"> </span>iPrimaryVariable<span class="p">;</span>
<span class="w">  </span>int<span class="w"> </span>iNumPrimaryVariable<span class="p">;</span>
<span class="w">  </span>...
<span class="w">  </span>double<span class="w"> </span>dPrimaryVariable<span class="p">;</span>
<span class="w">  </span>...
<span class="w">  </span>int<span class="w"> </span>iPrimaryVariablePhysics<span class="p">;</span>
<span class="w">  </span>...
<span class="w">  </span>double<span class="w"> </span>*pdDPrimaryVariableDtPhysics<span class="p">;</span>
<span class="w">  </span>...
<span class="o">}</span><span class="p">;</span>
</pre></div>
</div>
<p>The first parameter describes the position of this variable in the UPDATE matrix;
the second is the total number of processes that can modify the primary variable;
the third is the value of the primary variable at a given timestep; and the
final variable is a pointer to the instantaneous derivative. Although not shown
here, don’t forget to add the Doxygen comments.</p>
<p>Next, add a new function class for the variable in vplanet.h in the block of
declarations for the other primary variables:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>typedef<span class="w"> </span>void<span class="w"> </span><span class="o">(</span>*fnFinalizeUpdatePrimaryVariableModule<span class="o">)(</span>BODY<span class="w"> </span>*,<span class="w"> </span>UPDATE<span class="w"> </span>*,
<span class="w">              </span>int<span class="w"> </span>*,<span class="w"> </span>int,<span class="w"> </span>int,<span class="w"> </span>int<span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
<p>and add it to the MODULE struct:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>struct<span class="w"> </span>MODULE<span class="w"> </span><span class="o">{</span>
<span class="w">  </span>...
<span class="w">  </span>fnFinalizeUpdatePrimaryVariableModule<span class="w"> </span>**fnFinalizeUpdatePrimaryVariable<span class="p">;</span>
<span class="w">  </span>...
<span class="o">}</span><span class="p">;</span>
</pre></div>
</div>
<p>The next step is to add a unique identifier in update.h:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#define VPRIMARYVARIABLE 2000     // Dummy primary variable</span>
</pre></div>
</div>
<p>where the “V” stands for variable, and the integer ID must be unique.</p>
<p>The final initialization step is to declare the subroutine that returns the
derivative in the module’s header file, which we’re calling physics.h for this
example.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>double<span class="w"> </span>fdDPrimaryVariableDt<span class="o">(</span>BODY<span class="w"> </span>*,<span class="w"> </span>SYSTEM<span class="w"> </span>*,<span class="w"> </span>int<span class="w"> </span>*<span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All subroutines that return the derivative of a primary variable must have
the argument list of the example above.</p>
</div>
</section>
<section id="initialization">
<h2>Initialization<a class="headerlink" href="#initialization" title="Link to this heading"></a></h2>
<p>With the header files updated, we now turn to the steps necessary in the .c
files. We start with update.c. First, initialize the number of processes that
can modify this variable in the InitializeUpdate function to 0, and create a
block of code that initializes the other pieces of the UPDATE struct.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>void<span class="w"> </span>InitializeUpdate<span class="o">(</span>BODY<span class="w"> </span>*body,<span class="w"> </span>CONTROL<span class="w"> </span>*control,<span class="w"> </span>MODULE<span class="w"> </span>*module,
<span class="w">                      </span>UPDATE<span class="w"> </span>*update,<span class="w"> </span>fnUpdateVariable<span class="w"> </span>****fnUpdate<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span>...
<span class="w">  </span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumPrimaryVariable<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">;</span>
<span class="w">  </span>...
<span class="w">  </span>//<span class="w"> </span>Set<span class="w"> </span>to<span class="w"> </span>-1<span class="w"> </span>to<span class="w"> </span>initialize<span class="p">;</span><span class="w"> </span>this<span class="w"> </span>is<span class="w"> </span>changed<span class="w"> </span><span class="k">if</span><span class="w"> </span>the<span class="w"> </span>user<span class="w"> </span>requests<span class="w"> </span>it
<span class="w">  </span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariable<span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">(</span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumPrimaryVariable<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>//<span class="w"> </span>At<span class="w"> </span>least<span class="w"> </span><span class="m">1</span><span class="w"> </span>module<span class="w"> </span>will<span class="w"> </span>use<span class="w"> </span>this<span class="w"> </span>variable

<span class="w">    </span>//<span class="w"> </span>Assign<span class="w"> </span>iVar<span class="w"> </span>accounting<span class="w"> </span>variables
<span class="w">    </span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariable<span class="w"> </span><span class="o">=</span><span class="w"> </span>iVar<span class="p">;</span>
<span class="w">    </span>update<span class="o">[</span>iBody<span class="o">]</span>.iaVar<span class="o">[</span>iVar<span class="o">]</span><span class="w">      </span><span class="o">=</span><span class="w"> </span>VPRIMARYVARIABLE<span class="p">;</span>
<span class="w">    </span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumEqns<span class="o">[</span>iVar<span class="o">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumPrimaryVariable<span class="p">;</span>
<span class="w">    </span>//<span class="w"> </span>Assign<span class="w"> </span>pointer<span class="w"> </span>to<span class="w"> </span>derivative
<span class="w">    </span>update<span class="o">[</span>iBody<span class="o">]</span>.pdVar<span class="o">[</span>iVar<span class="o">]</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span>body<span class="o">[</span>iBody<span class="o">]</span>.dPrimaryVariable<span class="p">;</span>
<span class="w">    </span>//<span class="w"> </span>Allocate<span class="w"> </span>memory
<span class="w">    </span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumBodies<span class="o">[</span>iVar<span class="o">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">       </span>malloc<span class="o">(</span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumPrimaryVariable<span class="w"> </span>*<span class="w"> </span>sizeof<span class="o">(</span>int<span class="o">))</span><span class="p">;</span>
<span class="w">    </span>update<span class="o">[</span>iBody<span class="o">]</span>.iaBody<span class="o">[</span>iVar<span class="o">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">       </span>malloc<span class="o">(</span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumPrimaryVariable<span class="w"> </span>*<span class="w"> </span>sizeof<span class="o">(</span>int<span class="w"> </span>*<span class="o">))</span><span class="p">;</span>
<span class="w">    </span>update<span class="o">[</span>iBody<span class="o">]</span>.iaType<span class="o">[</span>iVar<span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>malloc<span class="o">(</span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumPrimaryVariable<span class="w"> </span>*
<span class="w">       </span>sizeof<span class="o">(</span>int<span class="o">))</span><span class="p">;</span>
<span class="w">    </span>update<span class="o">[</span>iBody<span class="o">]</span>.iaModule<span class="o">[</span>iVar<span class="o">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">       </span>malloc<span class="o">(</span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumPrimaryVariable<span class="w"> </span>*<span class="w"> </span>sizeof<span class="o">(</span>int<span class="o">))</span><span class="p">;</span>

<span class="w">    </span>//<span class="w"> </span>Assign<span class="w"> </span>and<span class="w"> </span>alloate<span class="w"> </span>memory<span class="w"> </span><span class="k">for</span><span class="w"> </span>Runge-Kutta<span class="w"> </span>integration
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">(</span>control-&gt;Evolve.iOneStep<span class="w"> </span><span class="o">==</span><span class="w"> </span>RUNGEKUTTA<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">      </span>control-&gt;Evolve.tmpUpdate<span class="o">[</span>iBody<span class="o">]</span>.pdVar<span class="o">[</span>iVar<span class="o">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">         </span><span class="p">&amp;</span>control-&gt;Evolve.tmpBody<span class="o">[</span>iBody<span class="o">]</span>.dPrimaryVariable<span class="p">;</span>
<span class="w">      </span>control-&gt;Evolve.tmpUpdate<span class="o">[</span>iBody<span class="o">]</span>.iNumBodies<span class="o">[</span>iVar<span class="o">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">         </span>malloc<span class="o">(</span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumPrimaryVariable<span class="w"> </span>*<span class="w"> </span>sizeof<span class="o">(</span>int<span class="o">))</span><span class="p">;</span>
<span class="w">      </span>control-&gt;Evolve.tmpUpdate<span class="o">[</span>iBody<span class="o">]</span>.daDerivProc<span class="o">[</span>iVar<span class="o">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">         </span>malloc<span class="o">(</span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumPrimaryVariable<span class="w"> </span>*<span class="w"> </span>sizeof<span class="o">(</span>double<span class="o">))</span><span class="p">;</span>
<span class="w">      </span>control-&gt;Evolve.tmpUpdate<span class="o">[</span>iBody<span class="o">]</span>.iaType<span class="o">[</span>iVar<span class="o">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">         </span>malloc<span class="o">(</span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumPrimaryVariable<span class="w"> </span>*<span class="w"> </span>sizeof<span class="o">(</span>int<span class="o">))</span><span class="p">;</span>
<span class="w">      </span>control-&gt;Evolve.tmpUpdate<span class="o">[</span>iBody<span class="o">]</span>.iaModule<span class="o">[</span>iVar<span class="o">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">         </span>malloc<span class="o">(</span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumPrimaryVariable<span class="w"> </span>*<span class="w"> </span>sizeof<span class="o">(</span>int<span class="o">))</span><span class="p">;</span>
<span class="w">      </span>control-&gt;Evolve.tmpUpdate<span class="o">[</span>iBody<span class="o">]</span>.iaBody<span class="o">[</span>iVar<span class="o">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">         </span>malloc<span class="o">(</span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumPrimaryVariable<span class="w"> </span>*<span class="w"> </span>sizeof<span class="o">(</span>int<span class="w"> </span>*<span class="o">))</span><span class="p">;</span>
<span class="w">    </span><span class="o">}</span>

<span class="w">    </span>//<span class="w"> </span>Now<span class="w"> </span>allocate<span class="w"> </span>memory<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>of<span class="w"> </span>processes<span class="w"> </span>that<span class="w"> </span>affect<span class="w"> </span>this<span class="w"> </span>variable
<span class="w">    </span><span class="nv">iEqn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="o">(</span><span class="nv">iModule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">;</span><span class="w"> </span>iModule<span class="w"> </span>&lt;<span class="w"> </span>module-&gt;iNumModules<span class="o">[</span>iBody<span class="o">]</span><span class="p">;</span><span class="w"> </span>iModule++<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">      </span>module-&gt;fnFinalizeUpdatePrimaryVariable<span class="o">[</span>iBody<span class="o">][</span>iModule<span class="o">](</span>body,<span class="w"> </span>update,
<span class="w">                </span><span class="p">&amp;</span>iEqn,<span class="w"> </span>iVar,<span class="w"> </span>iBody,<span class="w"> </span>iFoo<span class="o">)</span><span class="p">;</span>
<span class="w">    </span><span class="o">}</span>

<span class="w">    </span><span class="o">(</span>*fnUpdate<span class="o">)[</span>iBody<span class="o">][</span>iVar<span class="o">]</span><span class="w">        </span><span class="o">=</span><span class="w"> </span>malloc<span class="o">(</span>iEqn<span class="w"> </span>*<span class="w"> </span>sizeof<span class="o">(</span>fnUpdateVariable<span class="o">))</span><span class="p">;</span>
<span class="w">    </span>update<span class="o">[</span>iBody<span class="o">]</span>.daDerivProc<span class="o">[</span>iVar<span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>malloc<span class="o">(</span>iEqn<span class="w"> </span>*<span class="w"> </span>sizeof<span class="o">(</span>double<span class="o">))</span><span class="p">;</span>
<span class="w">    </span>iVar++<span class="p">;</span><span class="w"> </span>//<span class="w"> </span>increment<span class="w"> </span>iVar<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>next<span class="w"> </span>primary<span class="w"> </span>variable
<span class="w">  </span><span class="o">}</span>
<span class="w">  </span>...
<span class="o">}</span>
</pre></div>
</div>
<p>There’s a lot going on here, but all these lines do is setup your new primary
variable.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The pdVar variable is a pointer to the update matrix’s element
(fnUpdate[iBody][iVar][iEqn]) that is calculated every time step. If you ever
assign a new value to this variable, you will overwrite the primary variable’s
derivative (which would be bad!).</p>
</div>
<p>Next we need to add code to the module file, physics.c in this example, for
which this primary variable will be added. First add a new function that
continues the initialization process:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>void<span class="w"> </span>InitializePrimaryVariablePhysics<span class="o">(</span>BODY<span class="w"> </span>*body,<span class="w"> </span>OPTIONS<span class="w"> </span>*options,
<span class="w">                        </span>UPDATE<span class="w"> </span>*update,<span class="w"> </span>double<span class="w"> </span>dAge,<span class="w"> </span>int<span class="w"> </span>iBody<span class="o">)</span><span class="w"> </span><span class="o">{</span>

<span class="w">  </span>//<span class="w"> </span><span class="s2">&quot;Type&quot;</span><span class="w"> </span>of<span class="w"> </span>update<span class="p">;</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>is<span class="w"> </span>an<span class="w"> </span>ordinary<span class="w"> </span>differential<span class="w"> </span>equation
<span class="w">  </span>update<span class="o">[</span>iBody<span class="o">]</span>.iaType<span class="o">[</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariable<span class="o">]</span>
<span class="w">                </span><span class="o">[</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariablePhysics<span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">;</span>
<span class="w">  </span>//<span class="w"> </span>here<span class="w"> </span>we<span class="w"> </span>assume<span class="w"> </span>only<span class="w"> </span>one<span class="w"> </span>body<span class="w"> </span>is<span class="w"> </span>affecting<span class="w"> </span>the<span class="w"> </span>way<span class="w"> </span>the<span class="w"> </span>variable<span class="w"> </span>is<span class="w"> </span>updated
<span class="w">  </span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumBodies<span class="o">[</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariable<span class="o">]</span>
<span class="w">                </span><span class="o">[</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariablePhysics<span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">;</span>
<span class="w">  </span>//<span class="w"> </span>allocate<span class="w"> </span>memory
<span class="w">  </span>update<span class="o">[</span>iBody<span class="o">]</span>.iaBody<span class="o">[</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariable<span class="o">]</span>
<span class="w">                </span><span class="o">[</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariablePhysics<span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>malloc<span class="o">(</span>
<span class="w">                </span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumBodies<span class="o">[</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariable<span class="o">]</span>
<span class="w">                </span><span class="o">[</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariablePhysics<span class="o">]</span><span class="w"> </span>*<span class="w"> </span>sizeof<span class="o">(</span>int<span class="o">))</span><span class="p">;</span>
<span class="w">  </span>//<span class="w"> </span>Assign<span class="w"> </span>body<span class="o">(</span>ies<span class="o">)</span><span class="w"> </span>that<span class="w"> </span>affect<span class="w"> </span>this<span class="w"> </span>derivative
<span class="w">  </span>update<span class="o">[</span>iBody<span class="o">]</span>.iaBody<span class="o">[</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariable<span class="o">]</span>
<span class="w">                </span><span class="o">[</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariablePhysics<span class="o">][</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>iBody<span class="p">;</span>
<span class="w">  </span>//<span class="w"> </span>Assign<span class="w"> </span>pointer<span class="w"> </span>the<span class="w"> </span>derivative
<span class="w">  </span>update<span class="o">[</span>iBody<span class="o">]</span>.pdDPrimaryVariableDtPhysics<span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="p">&amp;</span>update<span class="o">[</span>iBody<span class="o">]</span>.daDeriv<span class="o">[</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariable<span class="o">]</span>
<span class="w">                </span><span class="o">[</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariablePhysics<span class="o">]</span><span class="p">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Then add a new line to the AssignDerivative function to set the appropriate
function pointer to the fnUpdate matrix:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>void<span class="w"> </span>AssignPhysicsDerivatives<span class="o">(</span>BODY<span class="w"> </span>*body,<span class="w"> </span>EVOLVE<span class="w"> </span>*evolve,<span class="w"> </span>UPDATE<span class="w"> </span>*update,
<span class="w">                            </span>fnUpdateVariable<span class="w"> </span>***fnUpdate,<span class="w"> </span>int<span class="w"> </span>iBody<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span>...
<span class="w">  </span>fnUpdate<span class="o">[</span>iBody<span class="o">][</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariable<span class="o">]</span>
<span class="w">          </span><span class="o">[</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariablePhysics<span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span>fdDPrimaryVariableDtPhysics<span class="p">;</span>
<span class="w">  </span>...
<span class="o">}</span>
</pre></div>
</div>
<p>where “Physics” is the  module name. The function fdDPrimaryVariableDt is a
subroutine that return the derivative of the primary variable.</p>
<p>Next add the following block of code to the InitializeUpdatePhysics function in
the module’s file (physics.c):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>void<span class="w"> </span>InitializeUpdatePhysics<span class="o">(</span>BODY<span class="w"> </span>*body,<span class="w"> </span>UPDATE<span class="w"> </span>*update,<span class="w"> </span>int<span class="w"> </span>iBody<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span>...
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">(</span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumPrimaryVariable<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumVars++<span class="p">;</span>
<span class="w">  </span><span class="o">}</span>
<span class="w">  </span>update<span class="o">[</span>iBody<span class="o">]</span>.iNumPrimaryVariable++<span class="p">;</span>
<span class="w">  </span>...
<span class="o">}</span>
</pre></div>
</div>
<p>Then create the FinalizeUpdate function:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>void<span class="w"> </span>FinalizeUpdatePrimaryVariablePhysics<span class="o">(</span>BODY<span class="w"> </span>*body,<span class="w"> </span>UPDATE<span class="w"> </span>*update,
<span class="w">                                         </span>int<span class="w"> </span>*iEqn,<span class="w"> </span>int<span class="w"> </span>iVar,int<span class="w"> </span>iBody,
<span class="w">                                         </span>int<span class="w"> </span>iFoo<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span>update<span class="o">[</span>iBody<span class="o">]</span>.iaModule<span class="o">[</span>iVar<span class="o">][</span>*iEqn<span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>PHYSICS<span class="p">;</span>
<span class="w">  </span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariablePhysics<span class="w"> </span><span class="o">=</span><span class="w"> </span>*iEqn<span class="p">;</span>
<span class="w">  </span><span class="o">(</span>*iEqn<span class="o">)</span>++<span class="p">;</span>
<span class="w">  </span><span class="o">}</span>
</pre></div>
</div>
<p>where PHYSICS is the unique integer associated with the module you are
upgrading.</p>
<p>Then add the primary variable to the NullDerivatives function:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>void<span class="w"> </span>NullDerivativesPhysics<span class="o">(</span>BODY<span class="w"> </span>*body,<span class="w"> </span>EVOLVE<span class="w"> </span>*evolve,<span class="w"> </span>UPDATE<span class="w"> </span>*update,
<span class="w">                           </span>fnUpdateVariable<span class="w"> </span>***fnUpdate,<span class="w"> </span>int<span class="w"> </span>iBody<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span>...
<span class="w">  </span>fnUpdate<span class="o">[</span>iBody<span class="o">][</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariable<span class="o">]</span>
<span class="w">          </span><span class="o">[</span>update<span class="o">[</span>iBody<span class="o">]</span>.iPrimaryVariableMODULE<span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span>fndUpdateFunctionTiny<span class="p">;</span>
<span class="w">  </span>...
<span class="o">}</span>
</pre></div>
</div>
<p>The final initialization step is to update the AddModule function:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>void<span class="w"> </span>AddModulePhysics<span class="o">(</span>CONTROL<span class="w"> </span>*control,<span class="w"> </span>MODULE<span class="w"> </span>*module,<span class="w"> </span>int<span class="w"> </span>iBody,
<span class="w">                     </span>int<span class="w"> </span>iModule<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span>...
<span class="w">  </span>module-&gt;fnFinalizeUpdatePrimaryVariable<span class="o">[</span>iBody<span class="o">][</span>iModule<span class="o">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="p">&amp;</span>FinalizeUpdatePrimaryVariablePhysics<span class="p">;</span>
<span class="w">  </span>...
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="using-the-new-primary-variable">
<h2>Using the New Primary Variable<a class="headerlink" href="#using-the-new-primary-variable" title="Link to this heading"></a></h2>
<p>From here, you must add the particular functions that perform the mathematical
calculations associated with the primary variable. At the bare minimum, you must
add the fdDPrimaryVariableDt. Additionally, you may want to take advantage of
the PropsAux function to compute any intermediary parameters that make it easier
to understand the code. You may also need to update the ForceBehavior function.
If your new variable depends on arrays of parameters, you may also need to add
or update the InitializeBody, InitializeUpdate, InitializeTmpBody, and
InitializeTmpUpdate functions. See eqtide.c or distorb.c for examples of how
these functions work. And of course you’ll probably want to add <a class="reference external" href="option">options</a> and <a class="reference external" href="output">outputs</a>. Finally, add <a class="reference external" href="tests">examples and tests</a> to
show off your result and ensure that future upgrades don’t destroy your work.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="option.html" class="btn btn-neutral float-left" title="Add a VPLanet Option" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="coupling.html" class="btn btn-neutral float-right" title="Coupling Modules" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2024, The VPLanet Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>